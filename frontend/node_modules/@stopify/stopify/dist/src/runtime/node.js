"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const suspend_1 = require("./suspend");
const makeEstimator_1 = require("./makeEstimator");
const parse_runtime_opts_1 = require("../parse-runtime-opts");
let continuationsRTS;
function init(rts, opts = parse_runtime_opts_1.parseRuntimeOpts(process.argv.slice(2))) {
    continuationsRTS = rts;
    // This is not ideal. These opts should be passed to the runtime when
    // it is constructed.
    continuationsRTS.stackSize = opts.stackSize;
    continuationsRTS.remainingStack = opts.stackSize;
    continuationsRTS.restoreFrames = opts.restoreFrames;
    const suspendRTS = new suspend_1.RuntimeWithSuspend(continuationsRTS, opts.yieldInterval, makeEstimator_1.makeEstimator(opts), function () { return false; }, function () { return true; }, function (x) {
        this.estimator.cancel();
        if (x.type === 'exception') {
            throw x.value;
        }
    });
    if (typeof opts.stop !== 'undefined') {
        setTimeout(function () {
            suspendRTS.onYield = () => false;
        }, opts.stop * 1000);
    }
    let g = global;
    g.require = require;
    suspendRTS.g = g;
    let higherOrderFunctions = require(`../stopified/higherOrderFunctions.${continuationsRTS.kind}.node`);
    suspendRTS.stopifyArray = (arr) => higherOrderFunctions.stopifyArray(arr);
    return suspendRTS;
}
exports.init = init;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9ydW50aW1lL25vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFLQSx1Q0FBK0M7QUFDL0MsbURBQWdEO0FBQ2hELDhEQUF5RDtBQUV6RCxJQUFJLGdCQUFxQyxDQUFDO0FBRTFDLFNBQWdCLElBQUksQ0FDbEIsR0FBWSxFQUNaLE9BQW9CLHFDQUFnQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTNELGdCQUFnQixHQUFHLEdBQUcsQ0FBQztJQUV2QixxRUFBcUU7SUFDckUscUJBQXFCO0lBQ3JCLGdCQUFnQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQzVDLGdCQUFnQixDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQ2pELGdCQUFnQixDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBRXBELE1BQU0sVUFBVSxHQUFHLElBQUksNEJBQWtCLENBQUMsZ0JBQWdCLEVBQ3hELElBQUksQ0FBQyxhQUFhLEVBQ2xCLDZCQUFhLENBQUMsSUFBSSxDQUFDLEVBQ25CLGNBQXVCLE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUN0QyxjQUF1QixPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsRUFDckMsVUFBVSxDQUFTO1FBQ2pCLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLENBQUMsSUFBSSxLQUFLLFdBQVcsRUFBRTtZQUMxQixNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUM7U0FDZjtJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxPQUFPLElBQUksQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFO1FBQ3BDLFVBQVUsQ0FBQztZQUNULFVBQVUsQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDO1FBQ25DLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDO0tBQ3RCO0lBQ0gsSUFBSSxDQUFDLEdBQVEsTUFBTSxDQUFDO0lBQ3BCLENBQUMsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQ25CLFVBQWtCLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUUxQixJQUFJLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxxQ0FBcUMsZ0JBQWdCLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQztJQUVyRyxVQUFrQixDQUFDLFlBQVksR0FBRyxDQUFDLEdBQVUsRUFBRSxFQUFFLENBQUMsb0JBQW9CLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzFGLE9BQU8sVUFBVSxDQUFDO0FBQ3BCLENBQUM7QUFyQ0Qsb0JBcUNDIn0=
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * This program uses Selenium to run a Stopify benchmark in a browser.
 *
 * There are a few steps involved:
 *
 * 1. We serve the dist/ directory and the directory containing the benchmark
 *    on port 9999.
 *
 * 2. We use Selenium to start a browser (in headless mode, if we know how).
 *
 * 3. Using Selenium, we direct the browser to fetch the page.
 */
const selenium = require("selenium-webdriver");
const chrome = require("selenium-webdriver/chrome");
const path = require("path");
const parse_runtime_opts_1 = require("./parse-runtime-opts");
const browserLine_1 = require("./browserLine");
const express = require("express");
process.env.MOZ_HEADLESS = "1";
const stdout = process.stdout;
const [browser, ...args] = process.argv.slice(2);
const opts = parse_runtime_opts_1.parseRuntimeOpts(args);
const src = browserLine_1.benchmarkUrl(args);
// NOTE(sam): No typing for `headless()` option as of 8/30/2017.
// I've opened a PR to DefinitelyTyped to fix this.
// https://github.com/DefinitelyTyped/DefinitelyTyped/pull/19463
const chromeOpts = new chrome.Options()
    .headless()
    .addArguments(['--js-flags', '--harmony_tailcalls']);
const loggingPrefs = new selenium.logging.Preferences();
loggingPrefs.setLevel('browser', 'all');
let builder = new selenium.Builder()
    .forBrowser(browser)
    .setLoggingPrefs(loggingPrefs)
    .setChromeOptions(chromeOpts);
const driver = builder.build();
const app = express();
app.use(express.static(path.join(__dirname, '../../dist')));
app.use(express.static(path.dirname(opts.filename)));
app.use(express.static(path.join(__dirname, '../../../stopify-continuations/dist')));
let exitCode = 0;
const server = app.listen(() => {
    const port = server.address().port;
    const url = `http://127.0.0.1:${port}/benchmark.html#${src}`;
    console.log(`GET ${url}`);
    driver.get(url)
        .then(_ => driver.wait(selenium.until.titleIs('done'), 8 * 60 * 1000))
        .then(_ => driver.findElement(selenium.By.id('data')))
        .then(e => e.getAttribute("value"))
        .then(s => {
        stdout.write(s);
        if (!s.endsWith('OK.\n')) {
            exitCode = 1;
        }
    })
        .catch(exn => {
        stdout.write(`Got an exception: ${exn}`);
        exitCode = 1;
    })
        .then(_ => driver.quit())
        .then(_ => server.close())
        .then(_ => process.exit(exitCode));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVuSW5Ccm93c2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3J1bkluQnJvd3Nlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7Ozs7OztHQVdHO0FBQ0gsK0NBQStDO0FBQy9DLG9EQUFvRDtBQUNwRCw2QkFBNkI7QUFDN0IsNkRBQXdEO0FBQ3hELCtDQUE2QztBQUM3QyxtQ0FBbUM7QUFFbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEdBQUcsR0FBRyxDQUFDO0FBRS9CLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7QUFDOUIsTUFBTSxDQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ25ELE1BQU0sSUFBSSxHQUFHLHFDQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3BDLE1BQU0sR0FBRyxHQUFHLDBCQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7QUFFL0IsZ0VBQWdFO0FBQ2hFLG1EQUFtRDtBQUNuRCxnRUFBZ0U7QUFDaEUsTUFBTSxVQUFVLEdBQVMsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFHO0tBQzNDLFFBQVEsRUFBRTtLQUNWLFlBQVksQ0FBQyxDQUFDLFlBQVksRUFBRSxxQkFBcUIsQ0FBQyxDQUFDLENBQUM7QUFFdkQsTUFBTSxZQUFZLEdBQUcsSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBQ3hELFlBQVksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBRXhDLElBQUksT0FBTyxHQUFHLElBQUksUUFBUSxDQUFDLE9BQU8sRUFBRTtLQUNqQyxVQUFVLENBQUMsT0FBTyxDQUFDO0tBQ25CLGVBQWUsQ0FBQyxZQUFZLENBQUM7S0FDN0IsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUM7QUFFaEMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQy9CLE1BQU0sR0FBRyxHQUFHLE9BQU8sRUFBRSxDQUFDO0FBRXRCLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDNUQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNyRCxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUscUNBQXFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFckYsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDO0FBQ2pCLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFO0lBQzdCLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUM7SUFDbkMsTUFBTSxHQUFHLEdBQUcsb0JBQW9CLElBQUksbUJBQW1CLEdBQUcsRUFBRSxDQUFDO0lBQzdELE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzFCLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO1NBQ1osSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1NBQ3JFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztTQUNyRCxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ2xDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUNSLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDeEIsUUFBUSxHQUFHLENBQUMsQ0FBQztTQUNkO0lBQ0gsQ0FBQyxDQUFDO1NBQ0QsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1FBQ1gsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUN6QyxRQUFRLEdBQUcsQ0FBQyxDQUFDO0lBQ2YsQ0FBQyxDQUFDO1NBQ0QsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ3hCLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUN6QixJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7QUFDdkMsQ0FBQyxDQUFDLENBQUMifQ==
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const t = require("babel-types");
const hygiene_1 = require("@stopify/hygiene");
const bh = require("@stopify/util");
const h = require("../helpers");
const label_1 = require("./label");
const types = t.identifier('$__T');
exports.types = types;
const restoreNextFrame = t.identifier('restoreNextFrame');
exports.restoreNextFrame = restoreNextFrame;
const target = t.identifier('target');
exports.target = target;
const captureLocals = t.identifier('captureLocals');
exports.captureLocals = captureLocals;
const runtime = t.identifier('$__R');
exports.runtime = runtime;
const runtimeStack = t.memberExpression(runtime, t.identifier('stack'));
exports.runtimeStack = runtimeStack;
const captureExn = t.memberExpression(types, t.identifier('Capture'));
exports.captureExn = captureExn;
exports.endTurnExn = t.memberExpression(types, t.identifier('EndTurn'));
const isNormalMode = t.memberExpression(runtime, t.identifier('mode'));
exports.isNormalMode = isNormalMode;
const topOfRuntimeStack = t.memberExpression(runtimeStack, t.binaryExpression("-", t.memberExpression(runtimeStack, t.identifier("length")), t.numericLiteral(1)), true);
exports.topOfRuntimeStack = topOfRuntimeStack;
const stackFrameCall = t.callExpression(t.memberExpression(topOfRuntimeStack, t.identifier('f')), []);
exports.stackFrameCall = stackFrameCall;
const eagerStack = t.memberExpression(runtime, t.identifier('eagerStack'));
const shiftEagerStack = t.memberExpression(eagerStack, t.identifier('shift'));
const pushEagerStack = t.memberExpression(eagerStack, t.identifier('unshift'));
/**
 * Wrap callsites in try/catch block, lazily building the stack on catching a
 * Capture exception, then rethrowing.
 *
 *  jumper [[ x = f_n(...args) ]] =
 *    try {
 *      if (mode === 'normal') {
 *        x = f_n(...args);
 *      } else if (mode === restoring && target === n) {
 *        x = R.stack[R.stack.length-1].f();
 *      }
 *    } catch (exn) {
 *      if (exn instanceof Capture) {
 *        exn.stack.push(stackFrame);
 *      }
 *      throw exn;
 *    }
 */
function lazyCaptureLogic(path, opts) {
    const applyLbl = t.numericLiteral(label_1.getLabels(path.node)[0]);
    const exn = hygiene_1.fresh('exn');
    const nodeStmt = t.expressionStatement(path.node);
    const restoreNode = t.assignmentExpression(path.node.operator, path.node.left, stackFrameCall);
    const ifStmt = t.ifStatement(isNormalMode, t.blockStatement([nodeStmt]), t.ifStatement(t.binaryExpression('===', target, applyLbl), t.expressionStatement(restoreNode)));
    const exnStack = t.memberExpression(exn, t.identifier('stack'));
    // A small hack to avoid showing reporting $top as the function name for
    // top-level function calls
    let funName = bh.enclosingFunctionName(path);
    if (funName === '$top') {
        funName = undefined;
    }
    const tryStmt = t.tryStatement(t.blockStatement([ifStmt]), t.catchClause(exn, t.blockStatement([
        t.ifStatement(t.binaryExpression('instanceof', exn, captureExn), t.blockStatement([
            t.expressionStatement(t.callExpression(t.memberExpression(exnStack, t.identifier('push')), [
                t.objectExpression([
                    t.objectProperty(t.identifier('kind'), t.stringLiteral('rest')),
                    t.objectProperty(t.identifier('f'), restoreNextFrame),
                    t.objectProperty(t.identifier('index'), applyLbl),
                    t.objectProperty(t.identifier('this'), t.thisExpression()),
                ]),
            ])),
            t.expressionStatement(t.callExpression(captureLocals, [
                t.memberExpression(exnStack, t.binaryExpression('-', t.memberExpression(exnStack, t.identifier('length')), t.numericLiteral(1)), true)
            ])),
        ]), t.blockStatement([
            t.expressionStatement(t.callExpression(t.memberExpression(runtime, t.identifier('pushTrace')), [t.stringLiteral(h.locationString(funName, path, opts))]))
        ])),
        t.throwStatement(exn)
    ])));
    const stmtParent = path.getStatementParent();
    stmtParent.replaceWith(tryStmt);
    stmtParent.skip();
}
exports.lazyCaptureLogic = lazyCaptureLogic;
function lazyGlobalCatch(path, opts) {
    const applyLbl = t.numericLiteral(label_1.getLabels(path.node)[0]);
    const nodeStmt = t.expressionStatement(path.node);
    const restoreNode = t.assignmentExpression(path.node.operator, path.node.left, t.callExpression(t.memberExpression(t.memberExpression(topOfRuntimeStack, t.identifier('f')), t.identifier('apply')), [
        t.memberExpression(topOfRuntimeStack, t.identifier('this')),
        t.memberExpression(topOfRuntimeStack, t.identifier('params'))
    ]));
    const ifStmt = t.ifStatement(isNormalMode, t.blockStatement([
        t.expressionStatement(t.assignmentExpression('=', target, applyLbl)),
        nodeStmt
    ]), t.ifStatement(t.binaryExpression('===', target, applyLbl), t.expressionStatement(restoreNode)));
    const stmtParent = path.getStatementParent();
    stmtParent.replaceWith(ifStmt);
    stmtParent.skip();
}
exports.lazyGlobalCatch = lazyGlobalCatch;
/**
 * Eagerly build the stack, pushing frames before applications and popping on
 * their return. Capture exns are thrown straight to the runtime, passing the
 * eagerly built stack along with it.
 *
 *  jumper [[ x = f_n(...args) ]] =
 *    if (mode === 'normal') {
 *      eagerStack.unshift(stackFrame);
 *      x = f_n(...args);
 *      eagerStack.shift();
 *    } else if (mode === 'restoring' && target === n) {
 *      // Don't have to `unshift` to rebuild stack because the eagerStack is
 *      // preserved from when the Capture exn was thrown.
 *      x = R.stack[R.stack.length-1].f();
 *      eagerStack.shift();
 *    }
 */
function eagerCaptureLogic(path, opts) {
    const applyLbl = t.numericLiteral(label_1.getLabels(path.node)[0]);
    const nodeStmt = t.expressionStatement(path.node);
    const stackFrame = t.objectExpression([
        t.objectProperty(t.identifier('kind'), t.stringLiteral('rest')),
        t.objectProperty(t.identifier('f'), restoreNextFrame),
        t.objectProperty(t.identifier('index'), applyLbl),
        t.objectProperty(t.identifier('this'), t.thisExpression()),
    ]);
    const restoreNode = t.assignmentExpression(path.node.operator, path.node.left, stackFrameCall);
    const ifStmt = t.ifStatement(isNormalMode, t.blockStatement([
        t.expressionStatement(t.callExpression(pushEagerStack, [
            stackFrame,
        ])),
        t.expressionStatement(t.callExpression(captureLocals, [
            t.memberExpression(eagerStack, t.numericLiteral(0), true),
        ])),
        nodeStmt,
        t.expressionStatement(t.callExpression(shiftEagerStack, [])),
    ]), t.ifStatement(t.binaryExpression('===', target, applyLbl), t.blockStatement([
        t.expressionStatement(restoreNode),
        t.expressionStatement(t.callExpression(shiftEagerStack, [])),
    ])));
    ifStmt.isTransformed = true;
    const stmtParent = path.getStatementParent();
    stmtParent.replaceWith(ifStmt);
    stmtParent.skip();
}
exports.eagerCaptureLogic = eagerCaptureLogic;
/**
 * Special return-value to conditionally capture stack frames and propogate
 * returns up to the runtime.
 *
 *  jumper [[ x = f_n(...args) ]] =
 *    {
 *      let ret;
 *      if (mode === 'normal') {
 *        ret = f_n(...args);
 *      } else if (mode === 'restoring' && target === n) {
 *        ret = R.stack[R.stack.length-1].f();
 *      }
 *      if (ret instanceof Capture) {
 *        ret.stack.push(stackFrame);
 *        return ret;
 *      }
 *      if (mode === 'normal') x = ret;
 *    }
 */
function retvalCaptureLogic(path, opts) {
    const applyLbl = t.numericLiteral(label_1.getLabels(path.node)[0]);
    const left = path.node.left;
    const stackFrame = t.objectExpression([
        t.objectProperty(t.identifier('kind'), t.stringLiteral('rest')),
        t.objectProperty(t.identifier('f'), restoreNextFrame),
        t.objectProperty(t.identifier('index'), applyLbl),
        t.objectProperty(t.identifier('this'), t.thisExpression()),
    ]);
    const retStack = t.memberExpression(left, t.identifier('stack'));
    const restoreBlock = t.ifStatement(t.binaryExpression('instanceof', left, captureExn), t.blockStatement([
        t.expressionStatement(t.callExpression(t.memberExpression(retStack, t.identifier('push')), [
            stackFrame,
        ])),
        t.expressionStatement(t.callExpression(captureLocals, [
            t.memberExpression(retStack, t.binaryExpression('-', t.memberExpression(retStack, t.identifier('length')), t.numericLiteral(1)), true)
        ])),
        t.returnStatement(left),
    ]));
    const ifStmt = t.ifStatement(isNormalMode, t.expressionStatement(path.node), t.ifStatement(t.binaryExpression('===', target, applyLbl), t.expressionStatement(t.assignmentExpression('=', left, stackFrameCall))));
    const replace = t.ifStatement(bh.or(isNormalMode, t.binaryExpression('===', target, applyLbl)), t.blockStatement([
        ifStmt,
        restoreBlock,
    ]));
    replace.isTransformed = true;
    const stmtParent = path.getStatementParent();
    stmtParent.replaceWith(replace);
    stmtParent.skip();
}
exports.retvalCaptureLogic = retvalCaptureLogic;
function fudgeCaptureLogic(path) {
    return;
}
exports.fudgeCaptureLogic = fudgeCaptureLogic;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FwdHVyZUxvZ2ljcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jYWxsY2MvY2FwdHVyZUxvZ2ljcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLGlDQUFpQztBQUNqQyw4Q0FBeUM7QUFDekMsb0NBQW9DO0FBQ3BDLGdDQUFnQztBQUNoQyxtQ0FBb0M7QUF3QnBDLE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7QUFYakMsc0JBQUs7QUFZUCxNQUFNLGdCQUFnQixHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQWpCeEQsNENBQWdCO0FBa0JsQixNQUFNLE1BQU0sR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBbkJwQyx3QkFBTTtBQW9CUixNQUFNLGFBQWEsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBckJsRCxzQ0FBYTtBQXNCZixNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBbEJuQywwQkFBTztBQW1CVCxNQUFNLFlBQVksR0FBRyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztBQWpCdEUsb0NBQVk7QUFrQmQsTUFBTSxVQUFVLEdBQUcsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7QUF6QnBFLGdDQUFVO0FBMEJDLFFBQUEsVUFBVSxHQUFHLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0FBQzdFLE1BQU0sWUFBWSxHQUFHLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVB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
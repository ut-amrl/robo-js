"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * This transformation boxes certain assignable variables to preserve
 * reference equality when the stack is reconstructed.
 *
 * Preconditions:
 * 1. The freeIds pass has been applied.
 */
const t = require("babel-types");
const babel = require("babel-core");
const assert = require("assert");
const h = require("@stopify/util");
const normalize_js_1 = require("@stopify/normalize-js");
const immutable_1 = require("immutable");
const hygiene_1 = require("@stopify/hygiene");
function box(e) {
    return t.objectExpression([t.objectProperty(t.identifier('box'), e === null || e === undefined ?
            t.unaryExpression('void', t.numericLiteral(0)) : e)]);
}
exports.box = box;
function unbox(e) {
    const res = t.memberExpression(e, t.identifier('box'));
    res.mark = e.mark;
    return res;
}
/**
 * Produces 'true' if the identifier should be boxed.
 *
 * @param x an identifier
 * @param path the path to the enclosing Function or Program
 */
function shouldBox(binding, path) {
    if (binding.path.isFunctionDeclaration()) {
        return true;
    }
    if (path.node.type === 'FunctionExpression' &&
        path.node.id &&
        path.node.id.name === binding.identifier.name) {
        return false;
    }
    return (normalize_js_1.freeIds.isNestedFree(path, binding.identifier.name));
}
function liftDecl(self, decl) {
    self.liftDeclStack[self.liftDeclStack.length - 1].push(decl);
}
function liftAssign(self, assign) {
    self.liftAssignStack[self.liftAssignStack.length - 1].push(assign);
}
// NOTE(arjun): The following implements non-strict semantics, where
// arguments[i] and the ith formal argument are aliased. Recall that:
//
// > function F(x) { 'use strict'; arguments[0] = 100; return x }; F(200)
// 200
// > function F(x) { arguments[0] = 100; return x }; F(200)
// 100
//
// if (usesArgs) {
//   params.forEach((x, i) => {
//     if (boxedArgs.contains(x.name)) {
//       const arg = t.identifier('argument');
//       const init = t.assignmentExpression('=',
//         t.memberExpression(arg, t.numericLiteral(i), true),
//         x);
//       path.node.body.body.unshift(t.expressionStatement(init));
//     }
//   });
// }
function enterFunction(self, path) {
    const locals = immutable_1.Set.of(...Object.keys(path.scope.bindings));
    // Mutable variables from this scope that are not shadowed
    const vars0 = self.vars.subtract(locals);
    // Mutable variables from the inner scope
    const vars1 = locals.filter(x => shouldBox(path.scope.bindings[x], path)).toSet();
    const params = path.node.params;
    const boxedArgs = immutable_1.Set.of(...params.filter(x => vars1.includes(x.name))
        .map(x => x.name));
    path.node.boxedArgs = boxedArgs;
    self.parentPathStack.push(self.parentPath);
    self.varsStack.push(self.vars);
    self.parentPath = path;
    self.vars = vars0.union(vars1);
    self.liftDeclStack.push([]);
    self.liftAssignStack.push([]);
}
function exitFunction(self, path) {
    // Lift boxed declarations and hoisted function decl assignments.
    const decls = self.liftDeclStack.pop();
    const assigns = self.liftAssignStack.pop();
    path.node.body.body.unshift(...decls, ...assigns);
    // Box arguments if necessary. We do this after visiting the function
    // body or the initialization statements get messed up.
    path.node.boxedArgs.valueSeq().forEach((x) => {
        const init = t.expressionStatement(t.assignmentExpression("=", t.identifier(x), box(t.identifier(x))));
        init.__boxVarsInit__ = true;
        path.node.body.body.unshift(init);
    });
    self.vars = self.varsStack.pop();
    self.parentPath = self.parentPathStack.pop();
}
const visitor = {
    Program: {
        enter(path) {
            this.parentPathStack = [];
            this.varsStack = [];
            this.parentPath = path;
            // Stopify has used the top-level as a implicit continuation delimiter.
            // i.e., Stopify's continuations are like Racket continuations, which
            // don't capture the rest of a module:
            //
            // (define saved #f)
            // (define f (call/cc (lambda (k) (set! saved k) 100)))
            // (display 200)
            // ; Applying saved will not run (display 200) again
            //
            // Since continuations don't capture top-level definitions, we do not
            // need to box top-level assignable variables, which why we initialize
            // this.vars to the empty set.
            //
            // Note that boxing top-level assignables is also wrong: a boxed top-level
            // variable X is also available as window.X, which we would not know to
            // unbox.
            /**this.vars = Set<string>();**/
            const vars = Object.keys(path.scope.bindings)
                .filter(x => shouldBox(path.scope.bindings[x], path));
            this.vars = immutable_1.Set.of(...vars);
            this.liftDeclStack = [[]];
            this.liftAssignStack = [[]];
        },
        exit(path) {
            const decls = this.liftDeclStack.pop();
            const assigns = this.liftAssignStack.pop();
            if (this.liftDeclStack.length !== 0 ||
                this.liftAssignStack.length !== 0) {
                throw new Error(`Not all declarations or assignments lifted \
during boxing`);
            }
            path.node.body.unshift(...decls, ...assigns);
        }
    },
    ReferencedIdentifier(path) {
        path.skip();
        // NOTE(arjun): The parent type tests are because labels are
        // categorized as ReferencedIdentifiers, which is a bug in
        // Babel, in my opinion.
        if (path.parent.type === "BreakStatement" ||
            path.parent.type === 'ContinueStatement' ||
            path.parent.type === "LabeledStatement") {
            return;
        }
        if (this.vars.includes(path.node.name) ||
            (this.opts.boxes && this.opts.boxes.includes(path.node.name))) {
            path.replaceWith(unbox(path.node));
        }
    },
    VariableDeclaration(path) {
        assert(path.node.declarations.length === 1, 'variable declarations must have exactly one binding');
        const decl = path.node.declarations[0];
        if (decl.id.type !== "Identifier") {
            throw new assert.AssertionError({
                message: 'destructuring not supported'
            });
        }
        if (this.vars.includes(decl.id.name)) {
            liftDecl(this, t.variableDeclaration('var', [t.variableDeclarator(decl.id, box(h.eUndefined))]));
            if (decl.init === null) {
                path.remove();
            }
            else {
                path.replaceWith(t.assignmentExpression('=', decl.id, decl.init));
            }
        }
    },
    BindingIdentifier(path) {
        path.skip();
        if (path.parent.type !== "AssignmentExpression") {
            return;
        }
        if (this.vars.includes(path.node.name) ||
            (this.opts.boxes && this.opts.boxes.includes(path.node.name))) {
            path.replaceWith(unbox(path.node));
        }
    },
    FunctionExpression: {
        enter(path, state) {
            enterFunction(this, path);
        },
        exit(path, state) {
            exitFunction(this, path);
        }
    },
    FunctionDeclaration: {
        enter(path, state) {
            enterFunction(this, path);
        },
        exit(path, state) {
            exitFunction(this, path);
            const vars = this.vars;
            // NOTE(rachit): in `func` mode, the input function is marked with
            // topFunction. It shouldn't be boxed since we want to preserve its
            // signature.
            if (vars.includes(path.node.id.name) &&
                !(state.opts.compileFunction && path.node.topFunction)) {
                const fun = t.functionExpression(hygiene_1.fresh('fun'), path.node.params, path.node.body);
                // This is necessary to get the right function name in
                // a stack trace.
                if (path.node.id.name !== undefined) {
                    fun.originalName = path.node.id.name;
                }
                fun.mark = path.node.mark;
                fun.boxedArgs = path.node.boxedArgs;
                // Little hack necessary to preserve annotation left by freeIds and singleVarDecls
                fun.nestedFunctionFree = path.node.nestedFunctionFree;
                fun.renames = path.node.renames;
                const decl = t.variableDeclaration('var', [t.variableDeclarator(path.node.id, box(h.eUndefined))]);
                const stmt = t.expressionStatement(t.assignmentExpression('=', unbox(path.node.id), fun));
                liftDecl(this, decl);
                liftAssign(this, stmt);
                path.remove();
                path.skip();
            }
        }
    }
};
function plugin() {
    return { visitor };
}
exports.plugin = plugin;
function main() {
    const filename = process.argv[2];
    const opts = { plugins: [() => ({ visitor })], babelrc: false };
    babel.transformFile(filename, opts, (err, result) => {
        if (err !== null) {
            throw err;
        }
        console.log(result.code);
    });
}
if (require.main === module) {
    main();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm94QXNzaWduYWJsZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2FsbGNjL2JveEFzc2lnbmFibGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7OztHQU1HO0FBQ0gsaUNBQWlDO0FBQ2pDLG9DQUFvQztBQUNwQyxpQ0FBaUM7QUFFakMsbUNBQW1DO0FBQ25DLHdEQUFnRDtBQUNoRCx5Q0FBZ0M7QUFDaEMsOENBQXlDO0FBY3pDLFNBQWdCLEdBQUcsQ0FBQyxDQUFlO0lBQ2pDLE9BQU8sQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUM3RCxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQztZQUMvQixDQUFDLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMxRCxDQUFDO0FBSkQsa0JBSUM7QUFFRCxTQUFTLEtBQUssQ0FBQyxDQUFlO0lBQzVCLE1BQU0sR0FBRyxHQUFHLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQ2pELEdBQUksQ0FBQyxJQUFJLEdBQVMsQ0FBRSxDQUFDLElBQUksQ0FBQztJQUNoQyxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFFRDs7Ozs7R0FLRztBQUNILFNBQVMsU0FBUyxDQUFDLE9BQWdCLEVBQUUsSUFBc0M7SUFDekUsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFLEVBQUU7UUFDeEMsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUNELElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssb0JB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